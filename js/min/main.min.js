var config={mapXpx:parseInt($("#map").css("margin-left")),mapYpx:parseInt($(".header").height())+parseInt($(".header").css("margin-bottom"))+parseInt($(".header").css("margin-top"))+parseInt($(".header").css("padding-top"))+parseInt($(".header").css("padding-bottom")),mapWidth:20,mapHeight:20,wallLand:2,boxSize:15,canvas:document.querySelector("#canvas")};
function genMapFromData(b){var a=document.querySelector("#canvas"),c=config.mapWidth,e=config.mapHeight;a.width=(config.wallLand+config.boxSize)*c+config.wallLand;a.height=(config.wallLand+config.boxSize)*e+config.wallLand;a=a.getContext("2d");a.fillStyle="black";a.fillRect(0,0,(config.wallLand+config.boxSize)*c+config.wallLand,(config.wallLand+config.boxSize)*e+config.wallLand);a.clearRect((config.wallLand+config.boxSize)*c,config.wallLand,config.wallLand,config.boxSize);for(cr_l=0;cr_l<e;cr_l++){var d=
    b.x[cr_l],f=b.y[cr_l];for(i=0;i<c;i++)a.clearRect((config.boxSize+config.wallLand)*i+config.wallLand,(config.boxSize+config.wallLand)*cr_l+config.wallLand,config.boxSize,config.boxSize),0==d[i]&&a.clearRect((config.boxSize+config.wallLand)*(i+1),(config.boxSize+config.wallLand)*cr_l+config.wallLand,config.wallLand,config.boxSize),0==f[i]&&a.clearRect((config.boxSize+config.wallLand)*i+config.wallLand,(config.boxSize+config.wallLand)*(cr_l+1),config.boxSize,config.wallLand)}}
function moveRole(b,a,c){var e=(config.wallLand+config.boxSize)*mazeRunner.role.x+config.wallLand+(0<b?config.boxSize*b:0>b?config.wallLand*b:0),d=(config.wallLand+config.boxSize)*mazeRunner.role.y+config.wallLand+(0<a?config.boxSize*a:0>a?config.wallLand*a:0),e=config.canvas.getContext("2d").getImageData(e,d,1,1);if(0!=e.data[0]||0!=e.data[1]||0!=e.data[2]||255!=e.data[3]){mazeRunner.role.step++;mazeRunner.role.x+=b;mazeRunner.role.y+=a;document.querySelector("#step").innerHTML=mazeRunner.role.step;
    if(mazeRunner.role.x>=config.mapWidth||mazeRunner.role.y>=config.mapHeight)mazeRunner.role.x=0,mazeRunner.role.x=0,document.querySelector("#step").innerHTML=mazeRunner.role.step=Math.floor(0),document.querySelector("#complete").innerHTML=Math.floor(++mazeRunner.role.complete);document.querySelector(c).style.left=(config.wallLand+config.boxSize)*mazeRunner.role.x+config.wallLand+config.mapXpx+"px";document.querySelector(c).style.top=(config.wallLand+config.boxSize)*mazeRunner.role.y+config.wallLand+
        config.mapYpx+"px";updateSessionByWindow();b=mazeRunner.role;b.type="move";ws.send(JSON.stringify(b))}}function keyDownCallBack(b){if(13==b.keyCode)return $(".footer > input").is(":focus")||$(".footer > input").focus(),sendMessage();36<b.keyCode&&41>b.keyCode&&moveRole((b.keyCode-38)%2,(b.keyCode-39)%2,"#myself")}
function sendMessage(){var b=removeHTMLTag($(".footer > input").val());if(!b||void 0==b)return!1;$(".footer>input").val("");layer.tips(b,"#myself",{tips:[4,"#3595CC"],time:2500,tipsMore:!0,skin:"layer_tipes_skin"});b={type:"message",name:mazeRunner.role.name.replace(/"/g,'\\"'),text:b};ws.send(JSON.stringify(b))}function removeHTMLTag(b){b=b.replace(/<script.*?>.*?<\/script>/ig,"");b=b.replace(/<\/?[^>]*>/g,"");b=b.replace(/[ | ]*\n/g,"\n");return b=b.replace(/ /ig,"")}
$.ajax({type:"GET",url:"api/grid.php",dataType:"JSON",beforeSend:function(){$("#load_text").remove()},success:function(b){config.mapWidth=b.data.width;config.mapHeight=b.data.height;genMapFromData(b.data)}});document.body.onkeydown=keyDownCallBack;
(function(b){b.fn.extend({notify:function(a){var c=b.extend({type:"sticky",speed:500,onDemandButtonHeight:35},a);return this.each(function(){var a=b(this),d=b(".ondemand-button"),f=a.outerWidth()-d.outerWidth();d.css("left",f).css("margin-top","-35px");var g=-a.outerHeight();a.addClass(c.type).css("margin-top",g).addClass("visible").removeClass("hide");"ondemand"!=c.type?a.stop(!0,!1).animate({marginTop:0},c.speed):d.stop(!0,!1).animate({marginTop:0},c.speed);b(".close",a).click(function(){"ondemand"==
    c.type?a.stop(!0,!1).animate({marginTop:g},c.speed,function(){a.removeClass("visible").addClass("hide");d.stop(!0,!1).animate({marginTop:0},c.speed)}):a.stop(!0,!1).animate({marginTop:g},c.speed,function(){a.removeClass("visible").addClass("hide")})});"floated"==c.type?b(document).scroll(function(d){a.stop(!0,!1).animate({top:b(document).scrollTop()},c.speed)}).resize(function(d){a.stop(!0,!1).animate({top:b(document).scrollTop()},c.speed)}):"ondemand"==c.type&&d.click(function(){b(this).animate({marginTop:-35},
    c.speed,function(){a.removeClass("hide").addClass("visible").animate({marginTop:0},c.speed,function(){})})})})}})})(jQuery);function getSession(){if(!sessionStorage.getItem("mazeRunner")){var b=JSON.stringify({role:{id:0,x:0,y:0,complete:0,step:0,name:"",color:{red:Math.floor(100*Math.random())+100,green:Math.floor(100*Math.random())+100,blue:Math.floor(100*Math.random())+100}},others:{}});sessionStorage.mazeRunner=b}return sessionStorage.mazeRunner}
function initStorage(){var b=getSession();window.mazeRunner=JSON.parse(b)}function clearStorage(){window.mazeRunner.others={};updateSessionByWindow()}function updateSession(b,a,c){var e=JSON.parse(getSession());if("undefined"==typeof e[b]||"undefined"==typeof e[b][a])return console.log(e),!1;e[b][a]=c;window.mazeRunner=e;sessionStorage.mazeRunner=JSON.stringify(e);return!0}function updateSessionByWindow(){sessionStorage.mazeRunner=JSON.stringify(window.mazeRunner);return!0}initStorage();connect();
function connect(){ws=new WebSocket("ws://"+document.domain+":8283");ws.onopen=onopen;ws.onmessage=onmessage;ws.onclose=function(){console.log("\u8fde\u63a5\u5173\u95ed\uff0c\u5b9a\u65f6\u91cd\u8fde");clearStorage();$(".role_list").children("div").remove();$("#roles").children("div").remove();connect()};ws.onerror=function(){console.log("\u51fa\u73b0\u9519\u8bef")}}
function show_prompt(){var b=prompt("\u8bf7\u8f93\u5165\u6635\u79f0:");b&&"null"!=b||(alert("\u8f93\u5165\u540d\u5b57\u4e3a\u7a7a\u6216\u8005\u4e3a'null'\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165\uff01"),show_prompt());updateSession("role","name",b)}
function onopen(){mazeRunner.role.name||show_prompt();var b={type:"login",name:mazeRunner.role.name.replace(/"/g,'\\"'),x:mazeRunner.role.x,y:mazeRunner.role.y,complete:mazeRunner.role.complete,step:mazeRunner.role.step,color:mazeRunner.role.color};document.querySelector("#step").innerHTML=mazeRunner.role.step;document.querySelector("#complete").innerHTML=mazeRunner.role.complete;paintRole(mazeRunner.role.x,mazeRunner.role.y);ws.send(JSON.stringify(b))}
function onmessage(b){var a=JSON.parse(b.data);switch(a.type){case "ping":ws.send('{"type":"pong"}');break;case "login":var c=$(".role_list").children("div").length+1;b="<div class='role_one' client_id='"+a.id+"' style=' border-radius: 2px;background-color: rgb("+a.color.red+", "+a.color.green+", "+a.color.blue+");'><span class='role_metal'>"+c+"</span><span class='role_name'>"+a.name+"</span><span class='role_score'>"+a.complete+"\u5206</span></div>";$(".role_list").append(b);mazeRunner.others[a.id]||
(delete a.type,mazeRunner.others[a.id]=a,updateSessionByWindow(),repaintOther(a.x,a.y,a.id,a.color.red,a.color.green,a.color.blue));break;case "self":updateSession("role","id",a.id);c=1;$.each(a.client_list,function(b,d){var f="<div class='role_one' client_id='"+d.id+"' style=' border-radius: 2px;background-color: rgb("+d.color.red+", "+d.color.green+", "+d.color.blue+");'><span class='role_metal'>"+c+"</span><span class='role_name'>"+d.name+"</span><span class='role_score'>"+d.complete+"\u5206</span></div>";
    $(".role_list").append(f);mazeRunner.others[d.id]||d.id==a.id||(mazeRunner.others[d.id]=d,updateSessionByWindow());d.id!=a.id&&repaintOther(d.x,d.y,d.id,d.color.red,d.color.green,d.color.blue);c++});break;case "logout":$(".role_list").children("div[client_id='"+a.id+"']").remove();$("#roles").children("#"+a.id).remove();mazeRunner.others[a.id]&&(delete mazeRunner.others[a.id],updateSessionByWindow());break;case "move":move(a.x,a.y,a.id);break;case "message":layer.tips(a.text,"#"+a.id,{tips:[4,"#3595CC"],
    time:4E3,tipsMore:!0,skin:"layer_tipes_skin"});break;case "check":layer.msg("\u6570\u636e\u5f02\u5e38"),delete a.type,mazeRunner.role=a,updateSessionByWindow(),paintRole(a.x,a.y)}}
function paintRole(b,a){var c=(config.wallLand+config.boxSize)*b+config.wallLand+config.mapXpx+"px",e=(config.wallLand+config.boxSize)*a+config.wallLand+config.mapYpx+"px",d=mazeRunner.role.color.red,f=mazeRunner.role.color.green,g=mazeRunner.role.color.blue;0< !$("#myself").length&&$("#roles").append('<div id="myself" class="role"></div>');$("#myself").css({left:c,top:e,width:config.boxSize,height:config.boxSize,backgroundColor:"rgba("+d+","+f+","+g+",1)"})}
function repaintOther(b,a,c,e,d,f){b=(config.wallLand+config.boxSize)*b+config.wallLand+config.mapXpx+"px";a=(config.wallLand+config.boxSize)*a+config.wallLand+config.mapYpx+"px";var g='<div id="'+c+'"class="role"></div>';$("#roles").append(g);$("#"+c).css({left:b,top:a,width:config.boxSize,height:config.boxSize,backgroundColor:"rgba("+e+","+d+","+f+",1)"})}
function move(b,a,c){b=(config.wallLand+config.boxSize)*b+config.wallLand+config.mapXpx+"px";a=(config.wallLand+config.boxSize)*a+config.wallLand+config.mapYpx+"px";$("#"+c).css({left:b,top:a})};